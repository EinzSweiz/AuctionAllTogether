<div class="container mx-auto mt-10 flex flex-col items-center">
    <h2 class="text-2xl font-bold mb-6 text-center">Add a New Bid</h2>
    
    <!-- Display last highest bid price -->
    <div class="bg-black text-white text-center rounded-lg p-4 mb-6 w-full max-w-md">
        <p class="text-lg">
            Last Highest Bid Price: 
            {% if last_bid %}
                ${{ last_bid.amount }}
            {% else %}
                No bids yet
            {% endif %}
        </p>
    </div>

    <div class="bg-white shadow-md rounded-lg p-8 w-full max-w-md">
        <form method="POST" 
              id="bid-form" 
              action="{% url 'bids:add_bid' item_id=item.id %}" 
              hx-target="#update-bid" 
              hx-swap="innerHTML">
            {% csrf_token %}
            <div class="grid grid-cols-1 gap-4">
                {{ form.non_field_errors }}  <!-- Display form-wide errors -->
                
                <!-- Select for predefined bid increments -->
                <div class="form-group">
                    <label for="bid-increment" class="block text-sm font-medium text-gray-700">Select Bid Increment</label>
                    <select id="bid-increment" class="block w-full mt-1 border-gray-300 rounded-md" onchange="updateBidAmount()">
                        <option value="">Choose an increment</option>
                        <option value="10">+10</option>
                        <option value="20">+20</option>
                        <option value="30">+30</option>
                        <option value="100">+100</option>
                        <option value="1000">+1000</option>
                        <option value="custom">Custom Amount</option>
                    </select>
                </div>
                
                <!-- Input for custom bid amount -->
                <div class="form-group hidden" id="custom-bid-group">
                    <label for="custom-bid" class="block text-sm font-medium text-gray-700">Enter Custom Bid Amount</label>
                    <input type="number" id="custom-bid" class="mt-1 block w-full border-gray-300 rounded-md" placeholder="Enter your bid" min="0" step="0.01" oninput="updateHiddenBidAmount()">
                </div>

                <!-- Hidden input to submit the bid amount -->
                <input type="hidden" name="amount" id="bid-amount" value="">
            </div>
            <button type="button" class="mt-6 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded hover:bg-blue-700 transition duration-200" onclick="submitBid()">Submit Bid</button>
        </form>
    </div>
</div>

<script>
    function updateBidAmount() {
        const incrementSelect = document.getElementById('bid-increment');
        const customBidGroup = document.getElementById('custom-bid-group');
        const customBidInput = document.getElementById('custom-bid');
        const bidAmountInput = document.getElementById('bid-amount');

        // Check the selected value
        const selectedValue = incrementSelect.value;
        
        if (selectedValue === 'custom') {
            customBidGroup.classList.remove('hidden'); // Show custom input
            customBidInput.focus(); // Focus on the custom input
            bidAmountInput.value = ''; // Clear the hidden bid amount
        } else {
            customBidGroup.classList.add('hidden'); // Hide custom input
            const lastBidAmount = {{ last_bid.amount|default:0 }}; // Get last bid amount from context
            
            if (selectedValue) {
                // Update the bid amount based on selected increment
                bidAmountInput.value = (lastBidAmount + parseFloat(selectedValue)).toFixed(2); 
            } else {
                bidAmountInput.value = ''; // Clear if no selection
            }
        }
    }

    function updateHiddenBidAmount() {
        const customBidInput = document.getElementById('custom-bid');
        const bidAmountInput = document.getElementById('bid-amount');
        bidAmountInput.value = customBidInput.value; // Set hidden amount to custom input value
    }

    function submitBid() {
        const form = document.getElementById('bid-form');
        
        // Perform validation before submitting the form
        if (document.getElementById('bid-amount').value === '') {
            alert("Please select a bid increment or enter a custom amount.");
            return;
        }

        // Submit the form using HTMX
        htmx.ajax('POST', form.action, { 
            target: "#update-bid", 
            swap: "innerHTML", 
            values: new FormData(form) 
        });
    }
</script>
